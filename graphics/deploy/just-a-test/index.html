<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Canvas - carpets v2</title>

    <style>
        canvas {
            border: medium dotted green;
        }

        .hidden {
            display: none;
        }

        .visible {
            display: block;
        }

    </style>

    <script>
        var width = 200;
        var height = 200;
        var canvas = document.createElement("canvas");
        canvas.setAttribute("width", width);
        canvas.setAttribute("height", height);
        canvas.setAttribute("id", "canvas");

        var render = function (param) {
            var canvasElement = document.getElementById("canvasDiv");
            canvasElement.appendChild(canvas);
            var context = canvas.getContext("2d");
            context.fillStyle = 'white';
            context.fillRect(0, 0, width, height);
            context.getImageData(0, 0, width, height);
            var canvasData = context.getImageData(0, 0, width, height);
            var setPixel = function (x, y, r, g, b, a) {
                var index = 4 * (y * width + x);
                canvasData.data[index] = r;
                canvasData.data[index + 1] = g;
                canvasData.data[index + 2] = b;
                canvasData.data[index + 3] = a;
            };

            for (var x = 0; x < width; x++) {
                for (var y = 0; y < height; y++) {
                    var r = (Math.sin(x * y * param) * 255);
                    var g = (Math.sin(x * y * param) * 255);
                    var b = (Math.sin(x * y * param) * 255);
                    setPixel(x, y, r, g, b, 255);
                }
            }
            context.putImageData(canvasData, 0, 0);
            //console.log(canvas.toDataURL());
            document.getElementById("data-url-link").href = canvas.toDataURL();
            document.getElementById("canvas-data-url").innerHTML = canvas.toDataURL();
        };

        var displayCarpet = function () {
            pauseAnimation();
            render(1.0)
            document.getElementById("start-link").className = "visible";
            document.getElementById("pause-link").className = "hidden";
            document.getElementById("resume-link").className = "hidden";
        };

        var param;
        var timer;

        var startAnimation = function () {
            param = 0.0;
            resumeAnimation();
            document.getElementById("start-link").className = "hidden";
        };

        var resumeAnimation = function () {
            timer = setInterval(function () {
                param += 0.01;
                if (param > 2.0) {
                    param = 0.0;
                }
                render(param);
            }, 50);
            document.getElementById("pause-link").className = "visible";
            document.getElementById("resume-link").className = "hidden";
        };

        var pauseAnimation = function () {
            document.getElementById("pause-link").className = "hidden";
            document.getElementById("resume-link").className = "visible";
            clearInterval(timer);
        }

    </script>
</head>
<body onload="displayCarpet()">
<div id="canvasDiv"></div>
<a href="#" id="start-link" onclick="startAnimation()" class="visible">animate</a>
<a href="#" id="pause-link" onclick="pauseAnimation()" class="hidden">pause</a>
<a href="#" id="resume-link" onclick="resumeAnimation()" class="hidden">resume</a>
<a href="#" id="display-link" onclick="displayCarpet()" class="visible">reset</a>

<p>
    <a id="data-url-link" href="#">Open as data URL</a>
</p>

<textarea id="canvas-data-url" style="width: 500px; min-height: 200px"></textarea>

</body>
</html>